---
- yum: name=https://rdo.fedorapeople.org/rdo-release.rpm state=present
- yum: name=http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm state=present
- yum: name=git state=present
- git: repo=https://github.com/stackforge/packstack
       dest=/opt/packstack
- command: python setup.py install
           chdir=/opt/packstack
  when: development
- command: python setup.py install_puppet_modules
           chdir=/opt/packstack
  when: development
- yum: name=openstack-packstack state=present
  when: not development
- copy: src=files/openrc dest=/home/vagrant/openrc owner=vagrant group=vagrant mode=0644
- lineinfile: dest=/home/vagrant/.bashrc line='source $HOME/openrc'
- copy: src=files/setup.sh dest=/home/vagrant/scripts/setup.sh owner=vagrant group=vagrant mode=0755
- copy: src=files/initialize.sh dest=/home/vagrant/scripts/initialize.sh mode=0755 owner=vagrant group=vagrant
- filesystem: fstype=xfs dev=/dev/sdb force=yes
- filesystem: fstype=xfs dev=/dev/sdc force=yes

- file: path=/home/vagrant/answers state=directory owner=vagrant group=vagrant mode=0755

- set_fact: exclude_servers=""
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/packstack.answers owner=vagrant group=vagrant

- set_fact: exclude_servers="{{ compute }},{{ network }},{{ storage }},{{ shared }}"
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/controller.answers owner=vagrant group=vagrant

- set_fact: exclude_servers="{{ controller }},{{ network }},{{ storage }},{{ shared }}"
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/compute.answers owner=vagrant group=vagrant

- set_fact: exclude_servers="{{ controller }},{{ compute }},{{ storage }},{{ shared }}"
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/network.answers owner=vagrant group=vagrant

- set_fact: exclude_servers="{{ controller }},{{ compute }},{{ network }},{{ shared }}"
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/storage.answers owner=vagrant group=vagrant

- set_fact: exclude_servers="{{ controller }},{{ compute }},{{ network }},{{ storage }}"
- template: src=files/packstack.answers.j2 dest=/home/vagrant/answers/shared.answers owner=vagrant group=vagrant

- yum: name=patch state=present
  when: development
- copy: src=patches dest=/home/vagrant owner=vagrant group=vagrant mode=0644
  when: not development
- patch: patchfile=/home/vagrant/patches/mongodb.pp basedir=/ strip=1
  when: not development
- patch: patchfile=/home/vagrant/patches/nova_compute_libvirt.pp basedir=/ strip=1
  when: not development
